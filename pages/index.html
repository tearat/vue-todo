<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Todo app</title>
    <link rel="stylesheet" href="/css/todo.css">
    <link rel="icon" href="/img/favicon.ico" type="image/x-icon"/>
    <link href="https://fonts.googleapis.com/css?family=Roboto:300,500" rel="stylesheet">
</head>
<body>
    <nav>
        <a href="/">
            <h1>Vue.js blog app</h1>
        </a>
        <p>v0.1 (24.10.2017)</p>
    </nav>
    <div id="app">
        <form action="app.php" method="post" id="saveForm">
            <input type="hidden" name="content" id="hidden_input">
        </form>

        <p>Поиск:</p>
        <input type="text" v-model="search" placeholder="Поиск...">
        <br>
        
        <p>Новая запись:</p>
        <input type="text" v-model="newTodoText" placeholder="Новая запись..." v-on:keyup.enter="addTodo" id="addTodo">
        <br>
        <ul>
            <li 
                is="todo-item"
                v-for="(todo, index) in todos" 
                v-bind:key="todo.id"
                v-bind:title="todo.title"
                v-if="todo.title.toLowerCase().indexOf(search.toLowerCase()) != -1"
                v-on:remove="todos.splice(index, 1)">
            </li>
        </ul>
    </div>
    
    <script src="/js/jquery-3.2.1.min.js"></script>
    <script src="/js/vue.js"></script>
    <script>

        Vue.component('todo-item', {
            props: ['title'],
            template: '<li>{{ title }}\
                    <button class="delete_btn" v-on:click="$emit(\'remove\')">X</button></li>'
        })
        
        var app = new Vue({
            el: '#app',
            data: 
            {
                search: '',
                newTodoText: '',
                todos: '',
                nextTodoId: 0
            },
            methods: 
            {
                addTodo: function()
                {
                    this.todos.push(
                        {
                            id: this.nextTodoId++,
                            title: this.newTodoText
                        })
                    this.newTodoText = '';
                    console.info('Item created');
                    saveList();
                }
            }
        })
        
        // Загрузка данных из файла и парсинг строки в объект
        $.ajaxSetup({ cache: false });
        $.get('../data/people.txt', function(data)
        {
            app.todos = JSON.parse(data).sort();
            app.nextTodoId = app.todos.length+1;
//            console.groupCollapsed('Todos data');
//            console.log('app todos: '+ JSON.stringify( app.todos ) );
//            console.groupEnd();
        });
        
        // Обработчик клика для динамических объектов
        // Заменяет стандартный onClick селектора
        $(document).on('click', '.delete_btn', function(){
            console.info('Item deleted');
            saveList();
        });
        
        var saveList = function()
        {
            $.post('/app/saver.php', { content: JSON.stringify(app.todos) } );
        }
        
    </script>
</body>
</html>